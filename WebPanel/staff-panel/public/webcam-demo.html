<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plaka Tanıma Demo</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f7fa;
      }
      h1,
      h2 {
        color: #2c3e50;
      }
      .container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }
      .webcam-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #webcam,
      #canvas {
        width: 640px;
        height: 480px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      .button-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #2980b9;
      }
      button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
      }
      .result-container {
        margin-top: 20px;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .result-success {
        padding: 15px;
        border-left: 4px solid #4caf50;
        background-color: #f9f9f9;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .result-error {
        padding: 15px;
        border-left: 4px solid #f44336;
        background-color: #f9f9f9;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .plate-result {
        text-align: center;
        margin: 20px 0;
      }
      .plate-text {
        display: inline-block;
        padding: 10px 20px;
        background-color: #ffeb3b;
        color: #000;
        font-size: 24px;
        font-weight: bold;
        border: 2px solid #000;
        border-radius: 4px;
        letter-spacing: 2px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .result-details {
        margin-top: 15px;
      }
      .result-details p {
        margin: 8px 0;
      }
      .debug-images {
        margin-top: 20px;
      }
      .debug-images h4 {
        margin-bottom: 10px;
        color: #333;
      }
      .debug-images img {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        font-size: 18px;
        color: #3f51b5;
      }
      .loading::after {
        content: "";
        width: 20px;
        height: 20px;
        margin-left: 10px;
        border: 3px solid #3f51b5;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .home-link {
        display: inline-block;
        margin-top: 20px;
        color: #3498db;
        text-decoration: none;
      }
      .home-link:hover {
        text-decoration: underline;
      }
      /* Debug paneliyle ilgili stiller */
      .debug-panel {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background-color: #fffbf0;
        border: 1px solid #ffe0b2;
        border-radius: 4px;
      }

      .debug-panel.active {
        display: block;
      }

      .debug-panel h3 {
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 16px;
        color: #e65100;
      }

      .debug-info {
        font-family: monospace;
        background-color: #fff;
        padding: 10px;
        border: 1px solid #ddd;
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 10px;
      }

      .debug-image-preview {
        text-align: center;
        margin-top: 10px;
      }

      .debug-image-preview img {
        max-width: 100%;
        max-height: 300px;
        border: 1px solid #ddd;
      }

      .debug-controls {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      .debug-switch {
        display: flex;
        align-items: center;
        margin-top: 15px;
      }

      .debug-switch input {
        margin-right: 5px;
      }

      .debug-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
      }

      .debug-tab {
        padding: 8px 12px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        background-color: #f0f0f0;
        margin-right: 5px;
      }

      .debug-tab.active {
        background-color: #fff;
        border-color: #ddd;
        border-radius: 4px 4px 0 0;
      }

      .debug-tab-content {
        display: none;
      }

      .debug-tab-content.active {
        display: block;
      }

      .debug-section {
        margin-bottom: 15px;
      }

      .debug-note {
        font-size: 0.8em;
        color: #777;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Smart Parking System - Kameralı Plaka Tanıma Demo</h1>
      <p>
        Bu demo, iVCam ile telefonunuzu web kamerası olarak kullanarak plaka
        tanıma sistemini test etmenizi sağlar.
      </p>
      <a href="#" id="backToPanel" class="home-link">← Staff Panel'e Dön</a>

      <!-- Debug modu için anahtar ekleyelim -->
      <div class="debug-switch">
        <input type="checkbox" id="debugMode" checked />
        <label for="debugMode">Debug Modu</label>
      </div>
    </div>

    <div class="container">
      <h2>Kamera Görüntüsü</h2>
      <div class="form-group">
        <label for="parkingSelect">Otopark Seçin:</label>
        <select id="parkingSelect">
          <option value="17">Merkez Otopark (ID: 17)</option>
          <option value="23">Milas Otopark (ID: 23)</option>
        </select>
      </div>

      <div class="webcam-container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="canvas" style="display: none"></canvas>

        <div class="button-container">
          <button id="refreshCamerasBtn">Kameraları Yenile</button>
          <button id="startBtn">Kamerayı Başlat</button>
          <button id="captureBtn" disabled>Görüntü Yakala</button>
          <button id="resetBtn" disabled>Sıfırla</button>
        </div>
      </div>

      <div class="actions">
        <button id="entryBtn" disabled>Araç Girişi Yap</button>
        <button id="exitBtn" disabled>Araç Çıkışı Yap</button>
      </div>

      <div
        class="auto-capture-container"
        style="
          margin-top: 20px;
          padding: 15px;
          background-color: #f9f9f9;
          border-radius: 5px;
          border-left: 4px solid #3498db;
        "
      >
        <h3>Otomatik Çekim Modu</h3>
        <p style="margin-bottom: 10px">
          Kamera, belirli aralıklarla otomatik olarak görüntü alıp plaka
          tanımayı gerçekleştirebilir.
        </p>

        <div style="display: flex; align-items: center; margin-bottom: 10px">
          <label
            for="captureInterval"
            style="margin-right: 10px; font-weight: 600"
            >Çekim Aralığı (saniye):</label
          >
          <input
            type="number"
            id="captureInterval"
            min="5"
            max="60"
            value="20"
            style="
              width: 70px;
              padding: 5px;
              border-radius: 4px;
              border: 1px solid #ddd;
            "
          />
        </div>

        <div style="display: flex; align-items: center; margin-bottom: 10px">
          <label for="autoMode" style="margin-right: 10px; font-weight: 600"
            >İşlem Modu:</label
          >
          <select
            id="autoMode"
            style="padding: 5px; border-radius: 4px; border: 1px solid #ddd"
          >
            <option value="entry">Araç Girişi</option>
            <option value="exit">Araç Çıkışı</option>
          </select>
        </div>

        <div>
          <button id="startAutoBtn" disabled>Otomatik Çekimi Başlat</button>
          <button id="stopAutoBtn" disabled>Otomatik Çekimi Durdur</button>
        </div>
      </div>

      <div id="loading" class="loading">İşleniyor</div>

      <div id="resultContainer" class="result-container" style="display: none">
        <h3>Plaka Tanıma Sonucu</h3>
        <div id="resultContent" class="result-content"></div>
        <div class="action-buttons" style="margin-top: 20px; text-align: right">
          <button id="newCaptureBtn" class="btn btn-primary">
            Yeni Görüntü Çek
          </button>
        </div>
      </div>

      <!-- Debug paneli -->
      <div id="debugPanel" class="debug-panel">
        <h3>Debug Paneli</h3>

        <div class="debug-tabs">
          <div class="debug-tab active" data-tab="imageInfo">
            Görüntü Bilgileri
          </div>
          <div class="debug-tab" data-tab="apiRequests">API İstekleri</div>
        </div>

        <div id="imageInfoTab" class="debug-tab-content active">
          <div class="debug-section">
            <h4>Görüntü Kalitesi</h4>
            <select id="imageQualitySelect" class="form-control">
              <option value="1.0">Çok Yüksek (1.0)</option>
              <option value="0.9">Yüksek (0.9)</option>
              <option value="0.8" selected>Orta (0.8)</option>
              <option value="0.7">Düşük (0.7)</option>
              <option value="0.5">Çok Düşük (0.5)</option>
            </select>
            <p class="debug-note">
              Not: Daha yüksek kalite, daha büyük dosya boyutu demektir.
            </p>
          </div>
          <div class="debug-section">
            <h4>Görüntü Önizleme</h4>
            <img id="debugImagePreview" src="" alt="Debug Görüntü Önizleme" />
            <button id="downloadDebugImage" class="btn btn-sm">İndir</button>
          </div>
          <div class="debug-section">
            <h4>Görüntü Bilgileri</h4>
            <pre id="imageDebugInfo">Henüz görüntü yakalanmadı.</pre>
          </div>
        </div>

        <div id="apiRequestsTab" class="debug-tab-content">
          <div class="debug-info" id="apiDebugInfo"></div>
          <button id="clearApiDebugInfo" class="btn btn-sm">Temizle</button>
        </div>
      </div>
    </div>

    <script>
      // DOM elementleri
      const video = document.getElementById("webcam");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const startBtn = document.getElementById("startBtn");
      const captureBtn = document.getElementById("captureBtn");
      const resetBtn = document.getElementById("resetBtn");
      const entryBtn = document.getElementById("entryBtn");
      const exitBtn = document.getElementById("exitBtn");
      const resultContainer = document.getElementById("resultContainer");
      const resultContent = document.getElementById("resultContent");
      const resultData = document.getElementById("resultData");
      const parkingSelect = document.getElementById("parkingSelect");
      const loading = document.getElementById("loading");
      const startAutoBtn = document.getElementById("startAutoBtn");
      const stopAutoBtn = document.getElementById("stopAutoBtn");
      const captureInterval = document.getElementById("captureInterval");
      const autoMode = document.getElementById("autoMode");

      // Debug paneli elementleri
      const debugMode = document.getElementById("debugMode");
      const debugPanel = document.getElementById("debugPanel");
      const imageDebugInfo = document.getElementById("imageDebugInfo");
      const apiDebugInfo = document.getElementById("apiDebugInfo");
      const debugImagePreview = document.getElementById("debugImagePreview");
      const downloadDebugImage = document.getElementById("downloadDebugImage");
      const imageQualitySelect = document.getElementById("imageQualitySelect");
      const clearApiDebugInfo = document.getElementById("clearApiDebugInfo");
      const debugTabs = document.querySelectorAll(".debug-tab");
      const debugTabContents = document.querySelectorAll(".debug-tab-content");

      // API URL
      const API_BASE_URL =
        window.location.protocol + "//" + window.location.host;
      const API_URL = API_BASE_URL.includes("3000")
        ? "http://localhost:8005" // Geliştirme ortamı
        : API_BASE_URL; // Üretim ortamı

      // Durum
      let isStreaming = false;
      let capturedImage = null;
      let autoCapturing = false;
      let autoCapturingInterval = null;
      let autoCount = 0;
      let debugImageData = null;

      // Debug modu event listener
      debugMode.addEventListener("change", function () {
        if (this.checked) {
          debugPanel.classList.add("active");
        } else {
          debugPanel.classList.remove("active");
        }
      });

      // Debug tab'leri için event listener
      debugTabs.forEach((tab) => {
        tab.addEventListener("click", function () {
          const tabId = this.getAttribute("data-tab");

          // Aktif tab'ı güncelle
          debugTabs.forEach((t) => t.classList.remove("active"));
          this.classList.add("active");

          // Tab içeriğini göster
          debugTabContents.forEach((content) => {
            content.classList.remove("active");
            if (content.id === `${tabId}Tab`) {
              content.classList.add("active");
            }
          });
        });
      });

      // Debug görüntüsünü indirme
      downloadDebugImage.addEventListener("click", function () {
        if (debugImageData) {
          const link = document.createElement("a");
          link.download = "debug_image.jpg";
          link.href = debugImageData;
          link.click();
        }
      });

      // API Debug bilgilerini temizleme
      clearApiDebugInfo.addEventListener("click", function () {
        apiDebugInfo.textContent = "";
      });

      // Debug bilgisini göster
      function logDebugInfo(info, type = "image") {
        if (type === "image") {
          imageDebugInfo.textContent = info;
        } else if (type === "api") {
          const currentTime = new Date().toLocaleTimeString();
          apiDebugInfo.textContent += `[${currentTime}] ${info}\n\n`;
          apiDebugInfo.scrollTop = apiDebugInfo.scrollHeight;
        }
      }

      // Kamera cihazlarını listele ve seçici oluştur
      async function listCameraDevices() {
        try {
          // Kamera erişim izni iste
          await navigator.mediaDevices.getUserMedia({ video: true });

          // Tüm medya cihazlarını listele
          const devices = await navigator.mediaDevices.enumerateDevices();

          // Sadece video girişlerini filtrele
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );

          if (videoDevices.length === 0) {
            alert("Kamera bulunamadı. Lütfen bir kamera bağlayın.");
            return;
          }

          // Eğer HTML'de kamera seçici yoksa oluştur
          if (!document.getElementById("cameraSelect")) {
            const selectContainer = document.createElement("div");
            selectContainer.className = "form-group";
            selectContainer.innerHTML = `
              <label for="cameraSelect">Kamera Seçin (iVCam için listeden seçin):</label>
              <select id="cameraSelect" class="form-control"></select>
            `;

            // Kamera seçiciyi parkingSelect'in altına ekle
            const parkingSelectGroup = document.querySelector(".form-group");
            parkingSelectGroup.parentNode.insertBefore(
              selectContainer,
              parkingSelectGroup.nextSibling
            );
          }

          // Kamera seçiciyi doldur
          const cameraSelect = document.getElementById("cameraSelect");
          cameraSelect.innerHTML = "";

          videoDevices.forEach((device, index) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Kamera ${index + 1}`;

            // iVCam genellikle "HD Camera" veya "iVCam" içerir
            if (
              option.text.includes("iVCam") ||
              option.text.includes("HD Camera") ||
              option.text.includes("Virtual")
            ) {
              option.text += " (Muhtemelen iVCam)";
              option.selected = true;
            }

            cameraSelect.appendChild(option);
          });

          console.log(`${videoDevices.length} kamera cihazı bulundu`);
        } catch (err) {
          console.error("Kamera cihazları listelenirken hata:", err);
          alert("Kamera cihazlarına erişilemedi: " + err.message);
        }
      }

      // Kamera başlatma fonksiyonu
      async function startCamera() {
        try {
          // Önce kamera cihazlarını listele
          await listCameraDevices();

          // Seçilen kamera ID'sini al
          const cameraSelect = document.getElementById("cameraSelect");
          const selectedCameraId = cameraSelect ? cameraSelect.value : null;

          const constraints = {
            video: selectedCameraId
              ? {
                  deviceId: { exact: selectedCameraId },
                  width: 640,
                  height: 480,
                }
              : {
                  width: 640,
                  height: 480,
                },
          };

          console.log("Seçilen kamera ID:", selectedCameraId);

          // Kamera stream'ini al
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          isStreaming = true;

          // Düğme durumlarını güncelle
          startBtn.disabled = true;
          captureBtn.disabled = false;
          startAutoBtn.disabled = false;

          // Sonuçları temizle
          hideResults();

          console.log("Kamera başlatıldı");
        } catch (err) {
          console.error("Kamera başlatılırken hata oluştu:", err);
          alert(
            "Kamera erişimi sağlanamadı. Lütfen kamera izinlerini kontrol edin."
          );
        }
      }

      // Görüntü yakalama fonksiyonu
      function captureImage() {
        if (!isStreaming) return null;

        try {
          // Canvas boyutlarını ayarla
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          if (debugMode.checked) {
            console.log(`Canvas boyutları: ${canvas.width}x${canvas.height}`);
          }

          // Görüntü kalitesini alın
          const imageQuality = parseFloat(imageQualitySelect.value);
          if (debugMode.checked) {
            console.log(`Seçilen görüntü kalitesi: ${imageQuality}`);
          }

          // Videodan görüntüyü canvas'a çiz
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // Canvas'taki görüntüyü base64 formatında al
          const capturedImage = canvas.toDataURL("image/jpeg", imageQuality);

          // Görüntü boyutu hesaplama
          const base64Length = capturedImage.length;
          const base64Size = (base64Length - 22) * 0.75; // base64 overhead'i çıkar ve 3/4 oranını uygula
          const kbSize = (base64Size / 1024).toFixed(2);

          if (debugMode.checked) {
            console.log(
              `Yakalanan görüntü boyutu: ~${kbSize} KB (${base64Length} karakter)`
            );
          }

          // Debug için görüntü ön izleme ve bilgileri güncelle
          if (debugMode.checked) {
            debugImageData = capturedImage;
            debugImagePreview.src = capturedImage;

            // Debug bilgilerini güncelle
            const debugInfo = `Yakalama Zamanı: ${new Date().toLocaleTimeString()}
Görüntü Boyutları: ${canvas.width}x${canvas.height} piksel
Dosya Boyutu: ~ ${kbSize} KB 
Format: JPEG
Kalite: ${imageQuality}
Base64 Uzunluğu: ${base64Length} karakter`;

            logDebugInfo(debugInfo, "image");
          }

          // Düğme durumlarını güncelle
          captureBtn.disabled = true;
          resetBtn.disabled = false;
          entryBtn.disabled = false;
          exitBtn.disabled = false;

          // Kamerayı durdur
          stopCamera();

          // Canvas'ı göster
          canvas.style.display = "block";
          video.style.display = "none";

          // Sonuç panelini gizle (yeni görüntü çekildiğinde)
          resultContainer.style.display = "none";

          console.log("Görüntü başarıyla yakalandı");
          return capturedImage;
        } catch (err) {
          console.error("Görüntü yakalama hatası:", err);
          if (debugMode.checked) {
            logDebugInfo(
              `HATA: Görüntü yakalama hatası - ${err.message}`,
              "image"
            );
            logDebugInfo(`Görüntü yakalama hatası: ${err.message}`, "api");
          }
          return null;
        }
      }

      // Kamerayı durdurma fonksiyonu
      function stopCamera() {
        if (!isStreaming) return;

        const stream = video.srcObject;
        const tracks = stream.getTracks();

        tracks.forEach((track) => track.stop());
        video.srcObject = null;
        isStreaming = false;

        // Eğer otomatik çekim devam ediyorsa durdur
        if (autoCapturing) {
          stopAutoCapture();
        }

        console.log("Kamera durduruldu");
      }

      // Sıfırlama fonksiyonu
      function resetCapture() {
        // Canvas'ı temizle
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        capturedImage = null;

        // Video'yu göster, canvas'ı gizle
        canvas.style.display = "none";
        video.style.display = "block";

        // Düğme durumlarını güncelle
        resetBtn.disabled = true;
        entryBtn.disabled = true;
        exitBtn.disabled = true;
        startBtn.disabled = false;

        // Otomatik çekim düğmelerini güncelle
        startAutoBtn.disabled = isStreaming ? false : true;
        stopAutoBtn.disabled = true;

        // Sonuçları temizle
        hideResults();

        console.log("Görüntü sıfırlandı");
      }

      // Base64'ten Blob'a dönüştürme yardımcı fonksiyonu
      function base64ToBlob(base64, mimeType) {
        try {
          const byteCharacters = atob(base64);
          const byteArrays = [];

          for (let offset = 0; offset < byteCharacters.length; offset += 512) {
            const slice = byteCharacters.slice(offset, offset + 512);

            const byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) {
              byteNumbers[i] = slice.charCodeAt(i);
            }

            const byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
          }

          return new Blob(byteArrays, { type: mimeType });
        } catch (error) {
          console.error("Base64 -> Blob dönüşüm hatası:", error);
          if (debugMode.checked) {
            logDebugInfo(
              `Base64 -> Blob dönüşüm hatası: ${error.message}`,
              "api"
            );
          }
          throw new Error(`Görüntü dönüştürme hatası: ${error.message}`);
        }
      }

      // Giriş görüntüsünü işle
      function processEntryImage(imageData) {
        if (!imageData) {
          console.error("İşlenecek görüntü bulunamadı");
          return;
        }

        try {
          const parkingId = parkingSelect.value;
          if (debugMode.checked) {
            logDebugInfo(`Seçilen otopark ID: ${parkingId}`, "api");
          }

          // Base64'ten Blob'a dönüştür
          const base64Data = imageData.split(",")[1];
          const blob = base64ToBlob(base64Data, "image/jpeg");
          const blobSizeKB = Math.round(blob.size / 1024);

          if (debugMode.checked) {
            logDebugInfo(`Görüntü Blob boyutu: ~${blobSizeKB} KB`, "api");
          }

          // Form verisi oluştur
          const formData = new FormData();
          formData.append("file", blob, "plate.jpg");

          // API URL'sini oluştur
          const apiUrl = `${API_URL}/process-plate-entry?parking_id=${parkingId}&debug=${
            debugMode.checked ? "true" : "false"
          }&save_debug=true`;

          if (debugMode.checked) {
            logDebugInfo(`API İsteği: ${apiUrl}`, "api");
            logDebugInfo(
              `Görüntü boyutu: ~${blobSizeKB} KB, Format: JPEG, Base64 uzunluğu: ${base64Data.length} karakter`,
              "api"
            );
          }

          // Sonuç panelini göster ve yükleniyor mesajı
          resultContainer.style.display = "block";
          resultContent.innerHTML = `<div class="loading">İşleniyor...</div>`;
          loading.style.display = "block";

          // API isteği zamanını ölç
          const startTime = new Date().getTime();

          // API isteği gönder
          fetch(apiUrl, {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              const endTime = new Date().getTime();
              const duration = endTime - startTime;

              if (debugMode.checked) {
                logDebugInfo(`API yanıt süresi: ${duration}ms`, "api");
                logDebugInfo(`API yanıt durumu: ${response.status}`, "api");
              }

              if (!response.ok) {
                throw new Error(`API yanıt hatası: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              loading.style.display = "none";

              if (debugMode.checked) {
                logDebugInfo(
                  `API yanıtı: ${JSON.stringify(data, null, 2)}`,
                  "api"
                );
              }

              // Sonucu göster
              displayResult(data, "entry");
            })
            .catch((error) => {
              loading.style.display = "none";
              console.error("API hatası:", error);
              resultContent.innerHTML = `<div class="error">Hata: ${error.message}</div>`;

              if (debugMode.checked) {
                logDebugInfo(`API hatası: ${error.message}`, "api");
              }
            });
        } catch (error) {
          loading.style.display = "none";
          console.error("İşlem hatası:", error);
          resultContent.innerHTML = `<div class="error">İşlem hatası: ${error.message}</div>`;

          if (debugMode.checked) {
            logDebugInfo(`İşlem hatası: ${error.message}`, "api");
          }
        }
      }

      // Çıkış görüntüsünü işle
      function processExitImage(imageData) {
        if (!imageData) {
          console.error("İşlenecek görüntü bulunamadı");
          return;
        }

        try {
          const parkingId = parkingSelect.value;
          if (debugMode.checked) {
            logDebugInfo(`Seçilen otopark ID: ${parkingId}`, "api");
          }

          // Base64'ten Blob'a dönüştür
          const base64Data = imageData.split(",")[1];
          const blob = base64ToBlob(base64Data, "image/jpeg");
          const blobSizeKB = Math.round(blob.size / 1024);

          if (debugMode.checked) {
            logDebugInfo(`Görüntü Blob boyutu: ~${blobSizeKB} KB`, "api");
          }

          // Form verisi oluştur
          const formData = new FormData();
          formData.append("file", blob, "plate.jpg");

          // API URL'sini oluştur
          const apiUrl = `${API_URL}/process-plate-exit?parking_id=${parkingId}&debug=${
            debugMode.checked ? "true" : "false"
          }&save_debug=true`;

          if (debugMode.checked) {
            logDebugInfo(`API İsteği: ${apiUrl}`, "api");
            logDebugInfo(
              `Görüntü boyutu: ~${blobSizeKB} KB, Format: JPEG, Base64 uzunluğu: ${base64Data.length} karakter`,
              "api"
            );
          }

          // Sonuç panelini göster ve yükleniyor mesajı
          resultContainer.style.display = "block";
          resultContent.innerHTML = `<div class="loading">İşleniyor...</div>`;
          loading.style.display = "block";

          // API isteği zamanını ölç
          const startTime = new Date().getTime();

          // API isteği gönder
          fetch(apiUrl, {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              const endTime = new Date().getTime();
              const duration = endTime - startTime;

              if (debugMode.checked) {
                logDebugInfo(`API yanıt süresi: ${duration}ms`, "api");
                logDebugInfo(`API yanıt durumu: ${response.status}`, "api");
              }

              if (!response.ok) {
                throw new Error(`API yanıt hatası: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              loading.style.display = "none";

              if (debugMode.checked) {
                logDebugInfo(
                  `API yanıtı: ${JSON.stringify(data, null, 2)}`,
                  "api"
                );
              }

              // Sonucu göster
              displayResult(data, "exit");
            })
            .catch((error) => {
              loading.style.display = "none";
              console.error("API hatası:", error);
              resultContent.innerHTML = `<div class="error">Hata: ${error.message}</div>`;

              if (debugMode.checked) {
                logDebugInfo(`API hatası: ${error.message}`, "api");
              }
            });
        } catch (error) {
          loading.style.display = "none";
          console.error("İşlem hatası:", error);
          resultContent.innerHTML = `<div class="error">İşlem hatası: ${error.message}</div>`;

          if (debugMode.checked) {
            logDebugInfo(`İşlem hatası: ${error.message}`, "api");
          }
        }
      }

      // Sonucu görüntüle
      function displayResult(data, type) {
        // Yükleniyor göstergesini gizle
        loading.style.display = "none";

        // Sonuç panelini göster
        resultContainer.style.display = "block";

        let html = "";

        if (data.success) {
          // Plaka bilgisini al (API'den dönen değer)
          const plateText = data.plate_number || data.license_plate || "";

          // Başarılı sonuç
          html = `
            <div class="result-success">
              <h3>İşlem Başarılı</h3>
              <div class="plate-result">
                <span class="plate-text">${plateText}</span>
              </div>
              <div class="result-details">
                <p><strong>İşlem:</strong> ${
                  type === "entry" ? "Araç Girişi" : "Araç Çıkışı"
                }</p>
                <p><strong>Otopark:</strong> ${
                  parkingSelect.options[parkingSelect.selectedIndex].text
                }</p>
                <p><strong>Zaman:</strong> ${new Date().toLocaleString()}</p>
                ${
                  data.confidence
                    ? `<p><strong>Güven Oranı:</strong> %${Math.round(
                        data.confidence * 100
                      )}</p>`
                    : ""
                }
                ${
                  data.processing_time
                    ? `<p><strong>İşlem Süresi:</strong> ${data.processing_time.toFixed(
                        2
                      )}ms</p>`
                    : ""
                }
                ${
                  data.parking_fee
                    ? `<p><strong>Park Ücreti:</strong> ${data.parking_fee} TL</p>`
                    : ""
                }
                ${
                  data.duration_hours
                    ? `<p><strong>Park Süresi:</strong> ${data.duration_hours.toFixed(
                        2
                      )} saat</p>`
                    : ""
                }
              </div>
            </div>
          `;

          // Debug görüntüsü varsa ekle
          if (data.debug_image) {
            html += `
              <div class="debug-images">
                <h4>İşlenmiş Görüntü</h4>
                <img src="data:image/jpeg;base64,${data.debug_image}" alt="İşlenmiş Görüntü" />
              </div>
            `;
          }
        } else {
          // Plaka bilgisini al (API'den dönen değer)
          const plateText = data.plate_number || data.license_plate || "";
          const errorMessage =
            data.error || data.message || "Bilinmeyen bir hata oluştu";

          // Hata mesajı
          html = `
            <div class="result-error">
              <h3>İşlem Başarısız</h3>
              ${
                plateText
                  ? `
                <div class="plate-result">
                  <span class="plate-text">${plateText}</span>
                  <p><small>(Kısmi tanıma)</small></p>
                </div>
              `
                  : ""
              }
              <div class="result-details">
                <p><strong>Hata:</strong> ${errorMessage}</p>
                <p><strong>İşlem:</strong> ${
                  type === "entry" ? "Araç Girişi" : "Araç Çıkışı"
                }</p>
                <p><strong>Otopark:</strong> ${
                  parkingSelect.options[parkingSelect.selectedIndex].text
                }</p>
                <p><strong>Zaman:</strong> ${new Date().toLocaleString()}</p>
              </div>
            </div>
          `;
        }

        // Debug görüntüsü varsa ekle
        if (data.debug_image) {
          html += `
            <div class="debug-image">
              <h4>Debug Görüntüsü</h4>
              <img src="data:image/jpeg;base64,${data.debug_image}" alt="Debug Image" />
            </div>
          `;
        }

        resultContent.innerHTML = html;
      }

      // Sonuçları gösterme fonksiyonu
      function showResults(data, isSuccess) {
        resultContainer.style.display = "block";
        resultContent.className = isSuccess
          ? "result-content result-success"
          : "result-content result-error";
        resultData.textContent = JSON.stringify(data, null, 2);
      }

      // Sonuçları gizleme fonksiyonu
      function hideResults() {
        resultContainer.style.display = "none";
      }

      // Yükleniyor göstergesi
      function showLoading() {
        loading.style.display = "block";
        entryBtn.disabled = true;
        exitBtn.disabled = true;
      }

      function hideLoading() {
        loading.style.display = "none";
        entryBtn.disabled = false;
        exitBtn.disabled = false;
      }

      // Otomatik çekim başlatma fonksiyonu
      function startAutoCapture() {
        if (!isStreaming) {
          alert("Önce kamerayı başlatın");
          return;
        }

        const interval = parseInt(captureInterval.value) || 20;
        if (interval < 5) {
          alert("Çekim aralığı en az 5 saniye olmalıdır");
          return;
        }

        // Düğme durumlarını güncelle
        startAutoBtn.disabled = true;
        stopAutoBtn.disabled = false;
        captureBtn.disabled = true;
        entryBtn.disabled = true;
        exitBtn.disabled = true;

        // Otoçekim modu aktif
        autoCapturing = true;
        autoCount = 0;

        // Durum bildirimi göster
        showResults(
          {
            message: `Otomatik ${
              autoMode.value === "entry" ? "giriş" : "çıkış"
            } çekimi başlatıldı. Her ${interval} saniyede bir çekim yapılacak.`,
            status: "info",
          },
          true
        );

        // Log
        console.log(
          `Otomatik çekim başlatıldı: ${interval} saniye aralıkla ${autoMode.value} modu`
        );

        // İlk çekimi hemen yap
        setTimeout(autoCapture, 1000);

        // Belirtilen aralıklarla otomatik çekim yapmaya başla
        autoCapturingInterval = setInterval(autoCapture, interval * 1000);
      }

      // Otomatik çekim durdurma fonksiyonu
      function stopAutoCapture() {
        if (!autoCapturing) return;

        // Zamanlayıcıyı temizle
        clearInterval(autoCapturingInterval);
        autoCapturingInterval = null;
        autoCapturing = false;

        // Düğme durumlarını güncelle
        startAutoBtn.disabled = false;
        stopAutoBtn.disabled = true;
        captureBtn.disabled = false;

        // Durum bildirimi
        showResults(
          {
            message: `Otomatik çekim durduruldu. Toplam ${autoCount} çekim yapıldı.`,
            status: "info",
          },
          true
        );

        console.log("Otomatik çekim durduruldu");
      }

      // Otomatik görüntü yakalama ve işleme
      function autoCapture() {
        if (!isStreaming || !autoCapturing) return;

        try {
          // Canvas boyutlarını ayarla
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          if (debugMode.checked) {
            console.log(
              `Otomatik çekim - Canvas boyutları: ${canvas.width}x${canvas.height}`
            );
          }

          // Görüntü kalitesini alın
          const imageQuality = parseFloat(imageQualitySelect.value);
          if (debugMode.checked) {
            console.log(
              `Otomatik çekim - Seçilen görüntü kalitesi: ${imageQuality}`
            );
          }

          // Videodan görüntüyü canvas'a çiz
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // Canvas'taki görüntüyü base64 formatında al
          const capturedImage = canvas.toDataURL("image/jpeg", imageQuality);

          // Görüntü boyutu hesaplama
          const base64Length = capturedImage.length;
          const base64Size = (base64Length - 22) * 0.75; // base64 overhead'i çıkar ve 3/4 oranını uygula
          const kbSize = (base64Size / 1024).toFixed(2);

          if (debugMode.checked) {
            console.log(
              `Otomatik çekim - Yakalanan görüntü boyutu: ~${kbSize} KB (${base64Length} karakter)`
            );
            logDebugInfo(
              `Otomatik çekim #${++autoCount} başlatıldı - ${new Date().toLocaleTimeString()}`,
              "api"
            );
          }

          // Debug için görüntü ön izleme ve bilgileri güncelle
          if (debugMode.checked) {
            debugImageData = capturedImage;
            debugImagePreview.src = capturedImage;

            // Debug bilgilerini güncelle
            const debugInfo = `Otomatik Yakalama #${autoCount}
Zaman: ${new Date().toLocaleTimeString()}
Boyutlar: ${canvas.width}x${canvas.height} piksel
Dosya Boyutu: ~ ${kbSize} KB 
Format: JPEG
Kalite: ${imageQuality}
Base64 Uzunluğu: ${base64Length} karakter`;

            logDebugInfo(debugInfo, "image");
          }

          // Seçilen moda göre işlemi yap
          const mode = autoMode.value;
          const parkingId = parkingSelect.value;

          // Base64'ten Blob'a dönüştür
          const base64Data = capturedImage.split(",")[1];
          const blob = base64ToBlob(base64Data, "image/jpeg");

          // Form verisi oluştur
          const formData = new FormData();
          formData.append("file", blob, "plate.jpg");

          // API URL'sini oluştur
          const apiUrl = `${API_URL}/process-plate-${mode}?parking_id=${parkingId}&debug=${
            debugMode.checked ? "true" : "false"
          }&save_debug=true`;

          if (debugMode.checked) {
            logDebugInfo(`Otomatik API İsteği: ${apiUrl}`, "api");
            logDebugInfo(
              `İşlem modu: ${mode === "entry" ? "Araç Girişi" : "Araç Çıkışı"}`,
              "api"
            );
          }

          // API isteği zamanını ölç
          const startTime = new Date().getTime();

          // API isteği gönder
          fetch(apiUrl, {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              const endTime = new Date().getTime();
              const duration = endTime - startTime;

              if (debugMode.checked) {
                logDebugInfo(`Otomatik API yanıt süresi: ${duration}ms`, "api");
                logDebugInfo(
                  `Otomatik API yanıt durumu: ${response.status}`,
                  "api"
                );
              }

              if (!response.ok) {
                throw new Error(`API yanıt hatası: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              if (debugMode.checked) {
                logDebugInfo(
                  `Otomatik API yanıtı: ${JSON.stringify(data, null, 2)}`,
                  "api"
                );
              }

              // Sonucu göster
              displayResult(data, mode);

              // Başarılı sonuç durumunda bildirim göster
              if (data.success && data.plate_number) {
                showNotification(
                  `Plaka Tanındı: ${data.plate_number}`,
                  mode === "entry" ? "Araç Girişi" : "Araç Çıkışı"
                );
              }
            })
            .catch((error) => {
              console.error("Otomatik API hatası:", error);

              if (debugMode.checked) {
                logDebugInfo(`Otomatik API hatası: ${error.message}`, "api");
              }
            });
        } catch (err) {
          console.error("Otomatik görüntü yakalama hatası:", err);
          if (debugMode.checked) {
            logDebugInfo(
              `HATA: Otomatik görüntü yakalama hatası - ${err.message}`,
              "api"
            );
          }
        }
      }

      // Bildirim gösterme fonksiyonu
      function showNotification(title, body) {
        if (!("Notification" in window)) {
          console.log("Bu tarayıcı bildirim desteği sunmuyor");
          return;
        }

        if (Notification.permission === "granted") {
          const notification = new Notification(title, {
            body: body,
            icon: "/favicon.ico",
          });
        } else if (Notification.permission !== "denied") {
          Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
              const notification = new Notification(title, {
                body: body,
                icon: "/favicon.ico",
              });
            }
          });
        }
      }

      // Olay dinleyicileri
      startBtn.addEventListener("click", startCamera);
      captureBtn.addEventListener("click", captureImage);
      resetBtn.addEventListener("click", resetCapture);
      entryBtn.addEventListener("click", function () {
        const imageData = canvas.toDataURL(
          "image/jpeg",
          parseFloat(imageQualitySelect.value)
        );
        processEntryImage(imageData);
      });
      exitBtn.addEventListener("click", function () {
        const imageData = canvas.toDataURL(
          "image/jpeg",
          parseFloat(imageQualitySelect.value)
        );
        processExitImage(imageData);
      });
      document
        .getElementById("refreshCamerasBtn")
        .addEventListener("click", listCameraDevices);
      startAutoBtn.addEventListener("click", startAutoCapture);
      stopAutoBtn.addEventListener("click", stopAutoCapture);

      // Yeni görüntü çekme butonu
      document
        .getElementById("newCaptureBtn")
        .addEventListener("click", function () {
          // Sonuç panelini gizle
          resultContainer.style.display = "none";

          // Kamerayı yeniden başlat
          startCamera();

          // Butonları sıfırla
          captureBtn.disabled = false;
          resetBtn.disabled = true;
          entryBtn.disabled = true;
          exitBtn.disabled = true;
        });

      // Sayfa yüklendiğinde
      window.addEventListener("load", function () {
        console.log("API URL:", API_URL);
        // Debug modunu varsayılan olarak aktif et
        debugPanel.classList.add("active");
        // Sayfa yüklendiğinde kamera cihazlarını listele
        listCameraDevices();
        resetCapture();

        // Staff Panel'e Dön linkine tıklandığında localStorage kontrolü
        const backToPanel = document.getElementById("backToPanel");
        backToPanel.addEventListener("click", function (e) {
          e.preventDefault();

          // localStorage'dan token ve userId kontrolü
          const token = localStorage.getItem("token");
          const userId = localStorage.getItem("userId");

          if (debugMode.checked) {
            console.log("Token kontrolü:", token ? "Bulundu" : "Bulunamadı");
            console.log("UserID kontrolü:", userId ? "Bulundu" : "Bulunamadı");
          }

          // Eğer token ve userId varsa ana sayfaya, yoksa login sayfasına yönlendir
          if (token && userId) {
            window.location.href = "/";
          } else {
            window.location.href = "/login";
          }
        });
      });
    </script>
  </body>
</html>
